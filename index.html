<html>
<head>
    <title>authentication with msal.js app</title>
    <style>
        .hidden {
            visibility: hidden
        }

        .visible {
            visibility: visible
        }
    </style>
</head>
<body>
    <script src="msal.js" class="pre"></script>
    <script src="AuthenticationHandler.js" class="pre"></script>

    <h1>Sending an email with msal.js and Microsoft Graph</h1>
    <div>
        <div id="label">Sign-in with Microsoft</div>
        <button id="auth" onclick="login();">Login</button>
    </div>
    <div id="sendEmail" class="hidden">
        <input id="emailToSendTo" type="text" />
        <button id="auth" onclick="sendEmail();">Send email</button>
    </div>

    <pre class="response"></pre>

    <script class="pre">
        var applicationConfig = {
            clientID: '2730fe41-5ed4-446e-86cd-e58871ca001e',
            redirectUri: 'http://localhost:1530/',
            interactionMode: "popUp",
            graphEndpoint: "https://graph.microsoft.com/v1.0/me",
            graphScopes: ["user.read mail.send"]

        };
    </script>


    <script>
        // MSAL helpers
        // ------------
        // Initialize MSAL libraries by setting the Client Id and a callback
        // @config - variable containing basic configuration, such as Client Id, interaction mode, and Redirect Url
        // @authCallback - callback function to be called after sign-in completes.
        function createApplication(config, authCallback) {
            var userAgentApplication = new MSAL.UserAgentApplication(config.clientID, null, authCallback);
            userAgentApplication.redirectUri = config.redirectUri;
            userAgentApplication.interactionMode = config.interactionMode;

            // On page load, check if the token is present in the location hash and handle it
            var isCallback = userAgentApplication.isCallback(window.location.hash);
            if (isCallback) {
                userAgentApplication.handleAuthenticationResponse(window.location.hash);
            }
            return userAgentApplication;
        }

        var clientApplication;

        // Get an access token for a given scope
        // @scope: permissions (for instance Microsoft Graph scope)
        // @callback: callback function to be called with the token, or otherwise, and error.
        function getAccessToken(scope, callback) {
            clientApplication.acquireTokenSilent(scope, function callBackendApiCallback(errorDescription, token, error) {
                if (error) {
                    clientApplication.interactionMode = applicationConfig.interactionMode;
                    clientApplication.acquireToken(scope, function (error, token) {
                        if (token) {
                            callback(token, null);
                        }
                        if (error) {
                            callback(null, error);
                        }
                    });
                } else {
                    callback(token, errorDescription);
                }
            });
        }
    </script>

    <script>
        clientApplication = createApplication(applicationConfig, function (errorDescription, idToken, error) {
            if (idToken) {
                // Change button to Sign Out
                var authButton = document.getElementById('auth');
                authButton.innerHTML = 'logout';
                authButton.setAttribute('onclick', 'logout();');
                var label = document.getElementById('label');
                label.innerText = "Hello " + clientApplication.user.profile.name + "! Please send an email with Microsoft Graph";

                // Show the email address part
                var sendEmailSpan = document.getElementById('sendEmail');
                sendEmailSpan.className = "visible";
                var emailAddress = document.getElementById('emailToSendTo');
                emailAddress.value = clientApplication.user.username;
            }
            else {
                log(errorDescription);
            }
        });

        function login() {
            clientApplication.login();
        }

        function logout() {
            // Removes all sessions, need to call AAD endpoint to do full logout
            clientApplication.logout();
        }

        function sendEmail() {
            getAccessToken(applicationConfig.graphScopes, function (token, error) {
                if (token) {
                    var client = new XMLHttpRequest();
                    client.setRequestHeader("bearer", token);
                    client.open("POST", applicationConfig.graphEndpoint, false);
                    client.setRequestHeader("Content-Type", "text/json");
                    client.send({ 'message': email, 'saveToSentItems': true });
                    if (http.status == 200) {

                    }
                    else {
                        log(client.status + " " + client.statusText);
                    }
                }
                else {
                    log("Acquiring the token failed with error:" + error);
                }
            })
        }
    </script>

    <script>
        function log(s) {
            document.body.querySelector('.response').appendChild(document.createTextNode("\n\n" + JSON.stringify(s, true, 2)));
        }
    </script>

</body>

</html>
